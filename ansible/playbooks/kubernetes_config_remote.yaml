- name: Update remote config file
  hosts: 
  - aws_ec2_master
  gather_facts: true
  tasks:
  - name: Copy file 1
    ansible.builtin.copy:
      src: /home/renancoradini/projetos/kubernetes-cka/kubernetes/appteste-deployment.yaml
      dest: /home/ubuntu/appteste-deployment.yaml
     # remote_src: true
      owner: ubuntu
      group: ubuntu
      mode: '0644'

  - name: Copy file 2
    ansible.builtin.copy:
      src: /home/renancoradini/projetos/kubernetes-cka/kubernetes/appteste-service.yaml
      dest: /home/ubuntu/appteste-service.yaml
      owner: ubuntu
      group: ubuntu
      mode: '0644'

  - name: Copy file 3
    ansible.builtin.copy:
      src: /home/renancoradini/projetos/kubernetes-cka/kubernetes/dbpostgrest-deployment.yaml
      dest: /home/ubuntu/dbpostgrest-deployment.yaml
      owner: ubuntu
      group: ubuntu
      mode: '0644'

  - name: Copy file 4
    ansible.builtin.copy:
      src: /home/renancoradini/projetos/kubernetes-cka/kubernetes/dbpostgrest-service.yaml
      dest: /home/ubuntu/dbpostgrest-service.yaml
      owner: ubuntu
      group: ubuntu
      mode: '0644'

  - name: Copy file 5
    ansible.builtin.copy:
      src: /home/renancoradini/projetos/kubernetes-cka/kubernetes/ingress.yaml
      dest: /home/ubuntu/ingress.yaml
      owner: ubuntu
      group: ubuntu
      mode: '0644'

- hosts: 
   - aws_ec2_master
  become: true
  gather_facts: true
  tasks:
    - name: Apply new settings
      shell: |
            kubectl apply -f /home/ubuntu/appteste-deployment.yaml
            kubectl apply -f /home/ubuntu/appteste-service.yaml
            kubectl apply -f /home/ubuntu/dbpostgrest-deployment.yaml
            kubectl apply -f /home/ubuntu/dbpostgrest-service.yaml
            kubectl apply -f /home/ubuntu/ingress.yaml
            apt install awscli -y
        
    - name: Login into AWS ECR
      command: "aws ecr get-login-password --region us-west-2"
      register: command_output
    - set_fact:
        password: "{{ command_output.stdout }}"
   
    - name: Verifying var 
      set_fact:
        dbaccount: "{{groups['aws_ec2_master'] | map('extract',hostvars,'aws_account') | list | join(',')}}"
    - name: Verifying var 
      debug:
        msg: "{{dbaccount}} ee {{password}}"
    - name: Verify the cluster is working
      shell: |
            kubectl delete secret regcred
            kubectl create secret docker-registry regcred \
            --docker-server={{ dbaccount }}.dkr.ecr.us-west-2.amazonaws.com \
            --docker-username=AWS \
            --docker-password=={{password}} \
            --docker-email={{dbaccount}} \
            
    - name: Update image appteste
      command: "kubectl set image deployment/appteste-deployment appteste={{dbaccount}}.dkr.ecr.us-west-2.amazonaws.com/apptestev4:latest"

    - name: Update image dbpost
      command: "kubectl set image deployment/dbpostgrest-deployment dbpostgrest={{dbaccount}}.dkr.ecr.us-west-2.amazonaws.com/dbpost:latest"
                                          

                                          